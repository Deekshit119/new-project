<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_search_source">
    <sp_search_source action="INSERT_OR_UPDATE">
        <advanced_typeahead_config>true</advanced_typeahead_config>
        <condition/>
        <data_fetch_script><![CDATA[(function(query) {
	var results = [];
	//Here goes the logic. Compute results however you want!
	if (!gs.isLoggedIn())
		return results;
	var portalValue = $sp.getCatalogs().value;
	var sc;
	sc = new sn_sc.CatalogSearch().search(portalValue, '', query);
	sc.addQuery('sys_class_name', 'NOT IN', 'sc_cat_item_wizard');
	sc.addEncodedQuery('hide_sp=false^ORhide_spISEMPTY');
	if (facets.category)
		sc.addQuery("category", "IN", facets.category.join(","));
	if (facets.catalog)
		sc.addQuery("sc_catalogs", "CONTAINS", facets.catalog);
	sc.query();
	var catCount = 0;
	while (sc.next() && catCount < data.limit) {
		var catalog_item = new sn_sc.CatItem(sc.getUniqueValue());
		var category = catalog_item.getFirstAccessibleCategoryForSearch(facets.catalog ? facets.catalog : portalValue);
		if (!catalog_item.canViewOnSearch() 
			|| !category) {
			continue;
		}
		var item = {};
		item.type = "sc"; // supported types are "sc" and "sc_content"
		item.page = "sc_cat_item";
		if (sc.getRecordClassName() == "sc_cat_item_guide")
			item.page = "sc_cat_item_guide";
		else if (sc.getRecordClassName() == "sc_cat_item_content") {
			var gr = new GlideRecord('sc_cat_item_content');
			gr.get(sc.getUniqueValue());
			$sp.getRecordValues(item, gr, 'url,content_type,kb_article');
			item.type = "sc_content";
		}
		$sp.getRecordDisplayValues(item, sc, 'name,short_description,sys_id,sys_class_name');
		item.name = escapeHTMl(item.name);
		item.short_description = escapeHTMl(item.short_description);

		item['picture'] = catalog_item.getPicture();
		item['icon'] = catalog_item.getIcon();
		item['price'] = catalog_item.getCompleteItemPrice();
		item.score = parseInt(sc.ir_query_score.getDisplayValue());
		item.label = item.name;
		item.primary = item.name;
		// determine URL/target and default icon in case item has no picture/icon
		if (item.type == "sc") {
			item.url = '?id=' + item.page + '&sys_id=' + item.sys_id;
			item.default_icon = "folder-open-o";
		} else if (item.type == "sc_content") {
			item.default_icon = "book";
			if (item.content_type == "kb") {
				item.url = '?id=kb_article&sys_id=' + item.kb_article;
				item.default_icon = "file-text-o";
			} else if (item.content_type == "external") {
				item.url = item.url + "";
				item.target = '_blank';
			} else
				item.url = '?id=sc_cat_item&sys_id=' + item.sys_id;
		}
		results.push(item);
		catCount++;
	}

	$sp.logSearch('sc_cat_item', query, sc.getRowCount(), data.searchType);
	
	function escapeHTMl(value) {
		var entityMap = {
							"&": "&amp;",
							"<": "&lt;",
							">": "&gt;",
							'"': '&quot;',
							"'": '&#39;',
							"/": '&#x2F;'
						};
		if (!value) return value;
		value = String(value).replace(/[&<>"'\/]/g, function (s) {
            return entityMap[s];
        });

		return value;
	}

	return results;
})(query);
]]></data_fetch_script>
        <display_fields/>
        <enable_typeahead>true</enable_typeahead>
        <facet_generation_script><![CDATA[(function(query, facetService, searchResults) {
	
	var portalValue = $sp.getCatalogs().value;
	var sc;
	var results = [];
	if (gs.getProperty("glide.sc.largeSet.optimization.enable", "false") == "true")
		return;
	sc = new sn_sc.CatalogSearch().search(portalValue, '', query);
	sc.addQuery('sys_class_name', 'NOT IN', 'sc_cat_item_wizard');
	sc.addEncodedQuery('hide_sp=false^ORhide_spISEMPTY');
	sc.query();
	var catItemCount = 0;
	while (sc.next()) {
		var primaryCategory = sc.getValue("category");
		if (GlideStringUtil.isEligibleSysID(primaryCategory)) {
			var primaryCategoryJS = new sn_sc.CatCategory(primaryCategory);
			var catalog_item = new sn_sc.CatItem(sc.getUniqueValue());
			var category = catalog_item.getFirstAccessibleCategoryForSearch(portalValue);
			if (!catalog_item.canViewOnSearch() 
				|| !category || !primaryCategoryJS.canView()) {
				continue;
			}
			var item = {};
			item.categoryID = primaryCategory;
			var categoryJS = new sn_sc.CatCategory(primaryCategory);
			if (categoryJS) {
				item.categoryLabel = categoryJS.getTitle();
				item.catalogID = categoryJS.getCatalog();
				var catalogJS = new sn_sc.Catalog(item.catalogID);
				item.catalogLabel = catalogJS.getTitle();
			}
			results.push(item);
		}
	}
	var catalogMap = {};
	var categoryMap = {};
	var catalogCount = 0;
	results.forEach(function(item) {
		var catalogLabel = item.catalogLabel;
		var catalogValue = item.catalogID;
		var categoryLabel = item.categoryLabel;
		var categoryValue = item.categoryID;
		if (!categoryMap[categoryLabel]) {
			categoryMap[categoryLabel] = categoryValue;
		} else if ((categoryMap[categoryLabel] + "").indexOf(categoryValue) < 0) {
			categoryMap[categoryLabel] += "," + categoryValue;
		}
		if (!catalogMap[catalogLabel]) {
			catalogMap[catalogLabel] = catalogValue;
			catalogCount++;
		}
	});
	
	if (portalValue.split(",").length > 1) {
		var catalogFacet = facetService.createFacet(gs.getMessage('Catalog'), 'catalog');
		for (var label in catalogMap)
			catalogFacet.addFacetItem(label, catalogMap[label]);
	}
	
	var categoryFacet = facetService.createMultiChoiceFacet(gs.getMessage('ATF:Category_uppercase'), 'category');
	for (var label in categoryMap)
		categoryFacet.addFacetItem(label, categoryMap[label]);
})(query, facetService, searchResults);]]></facet_generation_script>
        <id>uk_sc</id>
        <is_scripted_source>true</is_scripted_source>
        <name>Skanska UK Catalogs</name>
        <page/>
        <pagination_supported>false</pagination_supported>
        <primary_display_field/>
        <roles/>
        <search_page_template><![CDATA[<div ng-if="item.type == 'sc'" class="sc">
  <a href="{{item.url}}" class="h4 text-primary m-b-sm block">
    <i ng-if="item.picture" class="ta-img" style="background-image:url('{{item.picture}}?t=small')"></i>
	<i ng-if="!item.picture && item.icon" class="ta-icon" style="background-image:url('{{item.icon}}'); width:16px; height:16px;margin-right:15px"></i>
    <i ng-if="!item.picture && !item.icon" class="ta-icon fa fa-shopping-cart"></i>
    <span ng-bind-html="highlight(item.name, data.q)"></span></a>
  <div ng-style="getBGImage(item)" ng-if="item.picture" class="img-responsive m-r item-image pull-left"></div>
  <p ng-bind-html="highlight(item.short_description, data.q)"></p>
  <span class="text-muted m-r-sm" ng-if="data.showPrices && item.price != '$0.00'">{{item.price}}</span>
</div>
<div ng-if="item.type == 'sc_content'">
  <a ng-if="item.content_type == 'external'" ng-href="{{::item.url}}" target="_blank" class="h4 text-primary m-b-sm block"><span ng-bind-html="highlight(item.name, data.q)"></span> ➚</a>
  <a ng-if="item.content_type == 'kb'" ng-href="?id=kb_article&sys_id={{::item.kb_article}}" class="h4 text-primary m-b-sm block">
    <i class="fa m-r-sm fa-file-text-o"></i>
    <span ng-bind-html="highlight(item.name, data.q)"></span>
  </a>
  <a ng-if="item.content_type == 'literal'" ng-href="?id={{item.page}}&sys_id={{item.sys_id}}" class="h4 text-primary m-b-sm block">
    <i class="fa m-r-sm fa-file-text-o"></i>
    <span ng-bind-html="highlight(item.name, data.q)"></span></a>
  <div ng-style="getBGImage(item)" ng-if="item.picture" class="img-responsive m-r item-image pull-left"></div>
  <p ng-bind-html="highlight(item.short_description, data.q)"></p>
</div>]]></search_page_template>
        <source_table/>
        <sys_class_name>sp_search_source</sys_class_name>
        <sys_created_by>erdinc.pinar@flyform.com</sys_created_by>
        <sys_created_on>2019-11-08 12:24:37</sys_created_on>
        <sys_customer_update>false</sys_customer_update>
        <sys_id>c506c8f81b85c410445f3150cd4bcbdc</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_name>Skanska UK Catalogs</sys_name>
        <sys_package display_value="UK ITSM" source="x_sksw_uk_itsm">7889315b1bd04410eb7365386e4bcbbb</sys_package>
        <sys_policy/>
        <sys_replace_on_upgrade>false</sys_replace_on_upgrade>
        <sys_scope display_value="UK ITSM">7889315b1bd04410eb7365386e4bcbbb</sys_scope>
        <sys_update_name>sp_search_source_c506c8f81b85c410445f3150cd4bcbdc</sys_update_name>
        <sys_updated_by>erdinc.pinar@flyform.com</sys_updated_by>
        <sys_updated_on>2019-11-08 12:24:37</sys_updated_on>
        <typeahead_glyph/>
        <typeahead_template><![CDATA[<!-- prefer item picture to item icon, prefer item icon to default icon -->
<i ng-if="match.model.picture" class="ta-img" style="background-image:url('{{match.model.picture}}?t=small')"></i>
<i ng-if="!match.model.picture && match.model.icon" class="ta-icon" style="background-image:url('{{match.model.icon}}'); width:16px; height:16px"></i>
<i ng-if="!match.model.picture && !match.model.icon" class="ta-icon fa fa-{{match.model.default_icon}}"></i>
<span ng-bind-html="match.label | uibTypeaheadHighlight:query"></span>
<strong ng-if="match.model.type == 'sc_content' && match.model.content_type == 'external'">➚</strong>]]></typeahead_template>
    </sp_search_source>
    <sys_translated_text action="delete_multiple" query="documentkey=c506c8f81b85c410445f3150cd4bcbdc"/>
</record_update>
